# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: software-factory
  description: "UDS Software Factory"
  version: "0.0.1"
  architecture: amd64

components:
  - name: workdir
    required: true
    actions:
      onCreate:
        before:
          - cmd: mkdir -p tmp
      onDeploy:
        before:
          - cmd: mkdir -p tmp

  - name: zarf-config
    required: true
    files:
      - source: zarf-config.yaml
        target: tmp/zarf-config.yaml

  - name: k3d-dubbd
    required: true
    files:
      - source: k3d-dubbd/zarf-package-big-bang-distro-k3d-amd64-2.2.0.tar.zst
        target: k3d-dubbd/zarf-package-big-bang-distro-k3d-amd64-2.2.0.tar.zst
      - source: component-zarf-configs/k3d-dubbd/zarf-config.yaml
        target: k3d-dubbd/zarf-config.yaml
    actions:
      onCreate:
        before:
          - cmd: mkdir -p k3d-dubbd
          - cmd: ./zarf package pull oci://ghcr.io/anthonywendt/big-bang-distro-k3d:2.2.0-amd64 --oci-concurrency 9 --output-directory k3d-dubbd --no-progress=true
      onDeploy:
        after:
          - cmd: ./zarf package deploy zarf-package-big-bang-distro-k3d-amd64-2.2.0.tar.zst --confirm --no-progress=true
            dir: k3d-dubbd

  - name: gitlab
    required: true
    files:
      - source: tmp/zarf-package-gitlab-amd64-0.0.1.tar.zst
        target: tmp/zarf-package-gitlab-amd64-0.0.1.tar.zst
    actions:
      onCreate:
        before:
          - cmd: ./zarf package pull oci://ghcr.io/anthonywendt/gitlab:0.0.1-amd64 --oci-concurrency 9 --output-directory tmp --no-progress=true
      onDeploy:
        after:
          - cmd: ./zarf package deploy zarf-package-gitlab-amd64-0.0.1.tar.zst --confirm --no-progress=true
            dir: tmp

  - name: gitlab-runner
    required: true
    files:
      - source: tmp/zarf-package-gitlab-runner-amd64-0.0.1.tar.zst
        target: tmp/zarf-package-gitlab-runner-amd64-0.0.1.tar.zst
    actions:
      onCreate:
        before:
          - cmd: ./zarf package pull oci://ghcr.io/anthonywendt/gitlab-runner:0.0.1-amd64 --oci-concurrency 9 --output-directory tmp --no-progress=true
      onDeploy:
        after:
          - cmd: ./zarf package deploy zarf-package-gitlab-runner-amd64-0.0.1.tar.zst --confirm --no-progress=true
            dir: tmp
