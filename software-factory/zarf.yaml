# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: software-factory
  description: "UDS Software Factory"
  version: "0.0.1"
  architecture: amd64

components:
  - name: workdir
    required: true
    actions:
      onCreate:
        before:
          - cmd: mkdir -p tmp
      onDeploy:
        before:
          - cmd: mkdir -p tmp
  - name: zarf-config
    required: true
    files:
      - source: zarf-config.yaml
        target: tmp/zarf-config.yaml
  - name: k3d-dubbd
    required: true
    files:
      - source: ../build/zarf-package-big-bang-distro-k3d-amd64-2.2.0.tar.zst
        target: tmp/zarf-package-big-bang-distro-k3d-amd64-2.2.0.tar.zst
    actions:
      onCreate:
        before:
          - cmd: ./zarf package pull oci://ghcr.io/anthonywendt/big-bang-distro-k3d:2.2.0-amd64 --oci-concurrency 9 --output-directory tmp --no-progress=true
      onDeploy:
        after:
          - cmd: ./zarf package deploy zarf-package-big-bang-distro-k3d-amd64-2.2.0.tar.zst --confirm --no-progress=true
            dir: tmp

  - name: gitlab
    required: true
    files:
      - source: ../build/zarf-package-gitlab-amd64-0.0.1.tar.zst
        target: tmp/zarf-package-gitlab-amd64-0.0.1.tar.zst
    actions:
      onCreate:
        before:
          - cmd: ./zarf package pull ghcr.io/anthonywendt/gitlab:0.0.1-amd64 --oci-concurrency 9 --output-directory tmp --no-progress=true
      onDeploy:
        after:
          - cmd: ./zarf package deploy zarf-package-gitlab-amd64-0.0.1.tar.zst --confirm --no-progress=true
            dir: tmp
  # - name: load-certs
  #   required: true
  #   import:
  #     path: ../k3d
  # - name: preflight
  #   required: true
  #   import:
  #     path: ../k3d
  # - name: download-flux
  #   required: true
  #   import:
  #     path: ../k3d
  # - name: bigbang
  #   required: true
  #   import:
  #     path: ../k3d
  # - name: import-gitlab-values
  #   required: true
  #   import:
  #     name: values
  #     url: oci://ghcr.io/anthonywendt/gitlab:0.0.1-skeleton
  # - name: import-gitlab
  #   required: true
  #   import:
  #     name: gitlab
  #     url: oci://ghcr.io/anthonywendt/gitlab:0.0.1-skeleton
